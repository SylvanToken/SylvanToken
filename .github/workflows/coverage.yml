name: ðŸ“Š Coverage Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

jobs:
  coverage:
    name: Generate Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Compile contracts
        run: npx hardhat compile
      
      - name: ðŸ“Š Generate coverage report
        run: |
          npx hardhat coverage --testfiles "test/libraries/*.test.js" --testfiles "test/integration/EnhancedTokenIntegration.test.js" || true
      
      - name: ðŸ“ˆ Coverage Summary
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq '.total' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: âœ… Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
            
            echo "Statements: $STATEMENTS%"
            echo "Branches: $BRANCHES%"
            
            if (( $(echo "$STATEMENTS < 79" | bc -l) )); then
              echo "âŒ Statement coverage below threshold (79%)"
              exit 1
            fi
            
            if (( $(echo "$BRANCHES < 75" | bc -l) )); then
              echo "âŒ Branch coverage below threshold (75%)"
              exit 1
            fi
            
            echo "âœ… Coverage thresholds met!"
          fi
      
      - name: ðŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: ðŸ’¾ Upload coverage artifacts
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: ðŸ“Š Coverage Badge
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Coverage badge can be generated here"
          # Badge generation logic can be added

  coverage-trend:
    name: Coverage Trend Analysis
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Download coverage
        uses: actions/download-artifact@v3
        with:
          name: coverage-report
      
      - name: ðŸ“ˆ Analyze trend
        run: |
          echo "## Coverage Trend" >> $GITHUB_STEP_SUMMARY
          echo "Coverage trend analysis can be implemented here" >> $GITHUB_STEP_SUMMARY
          echo "- Historical data tracking" >> $GITHUB_STEP_SUMMARY
          echo "- Trend visualization" >> $GITHUB_STEP_SUMMARY
