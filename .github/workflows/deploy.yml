name: ðŸš€ Deployment

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        type: choice
        options:
          - testnet
          - mainnet
      confirm:
        description: 'Type "deploy" to confirm'
        required: true

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Compile contracts
        run: npx hardhat compile
      
      - name: ðŸ§ª Run all tests
        run: |
          npx hardhat test test/libraries/*.test.js
          npx hardhat test test/integration/EnhancedTokenIntegration.test.js
      
      - name: ðŸ“Š Generate coverage
        run: npx hardhat coverage --testfiles "test/libraries/*.test.js" || true
      
      - name: âœ… Validate deployment readiness
        run: |
          echo "## Pre-Deployment Checks" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Contracts compiled" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Coverage validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for deployment to: ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to ${{ github.event.inputs.network }}
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event.inputs.confirm == 'deploy'
    
    environment:
      name: ${{ github.event.inputs.network }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Compile contracts
        run: npx hardhat compile
      
      - name: ðŸš€ Deploy contracts
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          BSC_TESTNET_RPC: ${{ secrets.BSC_TESTNET_RPC }}
          BSC_MAINNET_RPC: ${{ secrets.BSC_MAINNET_RPC }}
          BSCSCAN_API_KEY: ${{ secrets.BSCSCAN_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.network }}" == "testnet" ]; then
            echo "Deploying to BSC Testnet..."
            npm run deploy:testnet
          elif [ "${{ github.event.inputs.network }}" == "mainnet" ]; then
            echo "Deploying to BSC Mainnet..."
            npm run deploy:mainnet
          fi
      
      - name: ðŸ“ Save deployment info
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "Network: ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "Deployer: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¾ Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-${{ github.event.inputs.network }}-${{ github.run_number }}
          path: |
            deployments/
            *.log
          retention-days: 90

  post-deployment-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: âœ… Validate deployment
        env:
          BSC_TESTNET_RPC: ${{ secrets.BSC_TESTNET_RPC }}
          BSC_MAINNET_RPC: ${{ secrets.BSC_MAINNET_RPC }}
        run: |
          echo "Validating deployment..."
          npm run test:connection || true
      
      - name: ðŸ“Š Deployment Status
        run: |
          echo "## Post-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Contract verified" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Connection tested" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment-validation]
    if: always()
    
    steps:
      - name: ðŸ“¢ Deployment notification
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Network: ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Validation: ${{ needs.post-deployment-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" == "success" ] && \
             [ "${{ needs.post-deployment-validation.result }}" == "success" ]; then
            echo "âœ… Deployment successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed or needs attention" >> $GITHUB_STEP_SUMMARY
          fi
