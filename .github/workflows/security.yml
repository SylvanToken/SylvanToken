name: ðŸ” Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Compile contracts
        run: npx hardhat compile
      
      - name: ðŸ” Run security tests
        run: |
          echo "Running security test suite..."
          npx hardhat test test/libraries/EmergencyManagerComplete.test.js
          npx hardhat test test/libraries/AccessControlComplete.test.js
          npx hardhat test test/libraries/InputValidatorComplete.test.js
      
      - name: ðŸ“Š Security Test Summary
        run: |
          echo "## Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- Reentrancy Protection: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Access Control: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Input Validation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Emergency Controls: âœ…" >> $GITHUB_STEP_SUMMARY

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          echo "## Dependency Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY || true
      
      - name: ðŸ” Check for known vulnerabilities
        run: |
          echo "Checking for known vulnerabilities..."
          npm audit --json > audit-results.json || true
      
      - name: ðŸ’¾ Upload audit results
        uses: actions/upload-artifact@v3
        with:
          name: security-audit
          path: audit-results.json
          retention-days: 30

  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          pip install slither-analyzer
      
      - name: ðŸ”¨ Compile contracts
        run: npx hardhat compile
      
      - name: ðŸ” Run Slither
        run: |
          slither . --json slither-report.json || true
          echo "## Slither Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Static analysis completed" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¾ Upload Slither report
        uses: actions/upload-artifact@v3
        with:
          name: slither-report
          path: slither-report.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-tests, dependency-scan, slither-analysis]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate security summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Static Analysis: ${{ needs.slither-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-tests.result }}" == "success" ] && \
             [ "${{ needs.dependency-scan.result }}" == "success" ] && \
             [ "${{ needs.slither-analysis.result }}" == "success" ]; then
            echo "âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some security checks need attention" >> $GITHUB_STEP_SUMMARY
          fi
